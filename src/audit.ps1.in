#Requires -RunAsAdministrator

Write-Out "Audit script version 1.1.0`n" -ForegroundColor Green

//include "functions/hardware_readiness.ps1"

<# OPTIONS #>

$rocksaltPath = "C:\Rocksalt"

<# HELPER FUNCTIONS #>

//include "functions/helper.ps1"

<# INITIAL SETUP #>

$warnings = @()

# Ensure directory exists
if (-not (Test-Path -Path $rocksaltPath)) {
  New-Item -ItemType Directory -Path $rocksaltPath | Out-Null
  Write-Out "Output directory created: $rocksaltPath"
}
else {
  Write-Out "Output directory already exists: $rocksaltPath"
}


<# AUDIT INFORMATION #>

//include "functions/audit_info.ps1"


<# BRUTE FORCE PROTECTION #>

Write-Out "`n=== Running brute force commands ===`n" -ForegroundColor DarkYellow
net accounts /lockoutthreshold:10 | Out-Null
net accounts /lockoutwindow:5 | Out-Null
net accounts /lockoutduration:30 | Out-Null


<# TEAMVIEWER #>

//include "functions/teamviewer.ps1"


<# ROCKSALT USER #>

//include "functions/rocksalt_user.ps1"


<# WINDOWS 11 COMPATIBLE #>

//include "functions/windows11_compatible.ps1"


<# AUDITER INPUT #>

//ifndef NO_INPUT
//include "functions/audit_input.ps1"
//endif


<# BITLOCKER #>

//include "functions/bitlocker.ps1"


<# OUTPUT #>

Write-Out "`n=== Output ===`n" -ForegroundColor DarkYellow

if ($warnings.Count -gt 0 -and (Read-Y "Would you like to add warnings to notes?")) {
  if ($notes -ne "") {
    $notes += "; "
  }
  $notes += "Warnings: $($warnings -join ', ')"
}

//ifdef NO_INPUT
//include "functions/output_table_noinput.ps1"
//else
//include "functions/output_table.ps1"
//endif


<# SAVE OUTPUT #>

Write-Out "`n=== Saving output ===`n" -ForegroundColor DarkYellow

$scriptPath = Split-Path -Parent ([System.Diagnostics.Process]::GetCurrentProcess().MainModule.FileName)
Write-Out "Script directory: $scriptPath"
$outPaths = @(
  $scriptPath
  $rocksaltPath
) | Select-Object -Unique

foreach ($path in $outPaths) {
  $auditFile = Join-Path $path "Audit.txt"
  $line | Out-File -Append -FilePath $auditFile
  Write-Out "Audit information has been appended to $auditFile"

  $bitlockerFile = Join-Path $path $fbitlockerFilename
  $bitlockerInfo | Out-File -FilePath $bitlockerFile
  if (Test-Path $bitlockerFile) {
    Write-Out "Bitlocker saved to $bitlockerFile`n"
  }
  else {
    Write-Error "Failed to save Bitlocker info to $bitlockerFile`n"
  }
}
